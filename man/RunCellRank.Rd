% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/RunCellRank.R
\name{RunCellRank}
\alias{RunCellRank}
\title{Run CellRank analysis with kernel-estimator architecture}
\usage{
RunCellRank(
  srt = NULL,
  assay_x = "RNA",
  layer_x = "counts",
  assay_y = c("spliced", "unspliced"),
  layer_y = "counts",
  adata = NULL,
  group_by = NULL,
  cores = 1,
  linear_reduction = NULL,
  nonlinear_reduction = NULL,
  basis = NULL,
  mode = "stochastic",
  fitting_by = "stochastic",
  magic_impute = FALSE,
  knn = 5,
  t = 2,
  min_shared_counts = 30,
  n_pcs = 30,
  n_neighbors = 30,
  stream_smooth = NULL,
  stream_density = 2,
  arrow_size = 5,
  arrow_length = 5,
  arrow_density = 0.5,
  calculate_velocity_genes = FALSE,
  denoise = FALSE,
  kinetics = FALSE,
  kernel_type = c("velocity", "pseudotime", "cytotrace"),
  time_key = "dpt_pseudotime",
  estimator_type = c("GPCCA", "CFLARE"),
  use_connectivity_kernel = TRUE,
  velocity_weight = 0.8,
  connectivity_weight = 0.2,
  softmax_scale = 4,
  n_macrostates = NULL,
  schur_method = c("krylov", "brandts"),
  n_cells_terminal = 10,
  show_plot = TRUE,
  save_plot = FALSE,
  plot_format = c("pdf", "png", "svg"),
  plot_dpi = 300,
  plot_prefix = "cellrank",
  legend.position = "on data",
  palette = "Paired",
  palcolor = NULL,
  dirpath = "./cellrank",
  return_seurat = !is.null(srt),
  verbose = TRUE
)
}
\arguments{
\item{srt}{A Seurat object. Default is \code{NULL}.
If provided, \code{adata} will be ignored.}

\item{assay_x}{Assay to convert in the anndata object.}

\item{layer_x}{Layer name for \code{assay_x} in the Seurat object.}

\item{assay_y}{Assay to convert in the anndata object.}

\item{layer_y}{Layer names for the \code{assay_y} in the Seurat object.}

\item{adata}{An anndata object. Default is \code{NULL}.}

\item{group_by}{Variable to use for grouping cells in the Seurat object.}

\item{cores}{The number of cores to use for parallelization with \link[foreach:foreach]{foreach::foreach}.
Default is \code{1}.}

\item{linear_reduction}{Linear reduction method to use, e.g., \code{"PCA"}.}

\item{nonlinear_reduction}{Non-linear reduction method to use, e.g., \code{"UMAP"}.}

\item{basis}{The basis to use for reduction, e.g., \code{"UMAP"}.}

\item{mode}{Velocity estimation models to use.
Can be \code{"deterministic"}, \code{"stochastic"}, or \code{"dynamical"}.}

\item{fitting_by}{Method used to fit gene velocities for dynamical modeling.
Default is \code{"stochastic"}.}

\item{magic_impute}{Flag indicating whether to perform magic imputation.
Default is \code{FALSE}.}

\item{knn}{The number of nearest neighbors for \code{magic.MAGIC}.
Default is \code{5}.}

\item{t}{power to which the diffusion operator is powered for \code{magic.MAGIC}.
Default is \code{2}.}

\item{min_shared_counts}{Minimum number of counts (both unspliced and spliced) required for a gene.
Default is \code{30}.}

\item{n_pcs}{Number of principal components to use for linear reduction.
Default is \code{30}.}

\item{n_neighbors}{Number of neighbors to use for constructing the KNN graph.
Default is \code{30}.}

\item{stream_smooth}{Multiplication factor for scale in Gaussian kernel around grid point.}

\item{stream_density}{Controls the closeness of streamlines.
Default is \code{2}.}

\item{arrow_size}{Size of arrows.
Default is \code{5}.}

\item{arrow_length}{Length of arrows.}

\item{arrow_density}{Amount of velocities to show.}

\item{calculate_velocity_genes}{Boolean flag indicating whether to calculate velocity genes.}

\item{denoise}{Boolean flag indicating whether to denoise.}

\item{kinetics}{Boolean flag indicating whether to estimate RNA kinetics.}

\item{kernel_type}{Type of kernel to use: \code{"velocity"} (default, requires spliced/unspliced),
\code{"pseudotime"} (requires pre-computed pseudotime or auto-computes DPT),
or \code{"cytotrace"} (auto-computes CytoTRACE score, suitable for RNA-only data).}

\item{time_key}{Key in metadata for pseudotime. Used when \code{kernel_type = "pseudotime"}.
If the key doesn't exist, DPT pseudotime will be computed automatically.
Default is \code{"dpt_pseudotime"}.}

\item{estimator_type}{Type of estimator to use: \code{"GPCCA"} (default) or \code{"CFLARE"}.
GPCCA provides coarse-grained analysis and Schur decomposition.}

\item{use_connectivity_kernel}{Whether to combine the main kernel with ConnectivityKernel.
Default is \code{TRUE}.}

\item{velocity_weight}{Weight for the VelocityKernel when combining with ConnectivityKernel.
Default is \code{0.8}.}

\item{connectivity_weight}{Weight for the ConnectivityKernel when combining with VelocityKernel.
Default is \code{0.2}.
Weights are automatically normalized to sum to \code{1.0}.}

\item{softmax_scale}{Scaling parameter for softmax transformation of velocity kernel.
Default is \code{4}.}

\item{n_macrostates}{Number of macrostates to compute.
If \code{NULL} (default), automatically determined based on eigenvalue spectrum.}

\item{schur_method}{Method for Schur decomposition: \code{"krylov"} or \code{"brandts"}.
Only used for GPCCA estimator.}

\item{n_cells_terminal}{Minimum number of cells required for a state to be considered terminal.
Default is \code{10}.}

\item{show_plot}{Whether to show the plot.
Default is \code{FALSE}.}

\item{save_plot}{Whether to save plots to files. Default is \code{FALSE}.}

\item{plot_format}{Format for saved plots: \code{"png"} (default), \code{"pdf"}, or \code{"svg"}.}

\item{plot_dpi}{Resolution (DPI) for saved plots. Default is \code{300}.}

\item{plot_prefix}{Prefix for saved plot filenames. Default is "cellrank".}

\item{legend.position}{Position of legend in plots. Can be \code{"on data"}, \code{"right margin"}, \code{"bottom right"}, etc. Default is \code{"on data"}.}

\item{palette}{The palette to use for coloring cells.}

\item{palcolor}{A vector of colors to use as the palette.}

\item{dirpath}{The directory to save the plots. Default is \code{"./cellrank"}.}

\item{return_seurat}{Whether to return a Seurat object instead of an anndata object.
Default is \code{TRUE}.}

\item{verbose}{Whether to print the message.
Default is \code{TRUE}.}
}
\value{
Returns a Seurat object if \code{return_seurat = TRUE} or an anndata object with CellRank results stored in \code{obsm}, \code{obs}, and \code{varm} slots.
The estimator and kernel objects are stored in \code{srt@misc$cellrank}.

Lineage pseudotime columns are automatically added to metadata with prefix \code{"Lineage_"}
(e.g., \code{Lineage_Alpha}, \code{Lineage_Beta}), compatible with \link{LineagePlot}, \link{RunDynamicFeatures},
and \link{RunDynamicEnrichment}. These are computed by combining base pseudotime
(\code{cytotrace_pseudotime}, \code{dpt_pseudotime}, or \code{latent_time}) with fate probabilities.
}
\description{
CellRank is a powerful toolkit for studying cellular dynamics using Markov state modeling.
This function implements the modern kernel-estimator architecture recommended by CellRank,
which provides more flexibility and advanced features compared to the legacy API.
}
\examples{
\dontrun{
data(pancreas_sub)
pancreas_sub <- standard_scop(pancreas_sub)
pancreas_sub <- RunCellRank(
  srt = pancreas_sub,
  group_by = "SubCellType",
  cores = 6
)

CellDimPlot(
  pancreas_sub,
  group.by = "term_states_fwd",
  reduction = "umap",
  label = TRUE
)

FeatureDimPlot(
  pancreas_sub,
  features = "latent_time",
  reduction = "umap"
)

FeatureDimPlot(
  pancreas_sub,
  features = c("stochastic_confidence", "stochastic_length"),
  reduction = "umap"
)

CellDimPlot(
  pancreas_sub,
  group.by = "SubCellType",
  reduction = "UMAP",
  lineages = "cellrank_pseudotime",
  lineages_span = 0.1,
  lineages_trim = c(0.05, 0.95)
)

DynamicPlot(
  pancreas_sub,
  lineages = "cellrank_pseudotime",
  features = c("Arxes1", "Ncoa2"),
  group.by = "SubCellType"
)
}
}
\seealso{
\link{RunSCVELO}, \link{RunPAGA}, \link{VelocityPlot}, \link{CellDimPlot}, \link{DynamicPlot}
}
